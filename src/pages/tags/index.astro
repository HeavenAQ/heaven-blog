---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Body from '../../components/Body.astro';
import Container from '../../components/Container.astro';
import { getCollection } from 'astro:content';
import { slugify } from '../../lib/slug';

const posts = await getCollection('blog');
const map = new Map<string, number>();
for (const p of posts) {
  for (const t of (p.data.tags || [])) {
    map.set(t, (map.get(t) || 0) + 1);
  }
}
const tags = Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
---

<html lang="en">
  <head>
    <script is:inline>
      // Initialize theme BEFORE any CSS loads to prevent flash
      const theme = (() => {
        if(typeof localStorage !== 'undefined' && localStorage.getItem('theme')){
          return localStorage.getItem('theme')
        }
        if(window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark'
        }
        return 'light'
      })()

      if (theme === 'dark') {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
    </script>
    <BaseHead title="Tags" description="Browse posts by tag" />
  </head>
  <Body>
    <Header />
    <main class="pt-[80px]">
      <Container>
        <h1 class="text-2xl md:text-3xl font-bold font-mplus">Tags</h1>
        <ul class="mt-6 flex flex-wrap gap-2 list-none p-0">
          {tags.map(([name, count]) => (
            <li class="list-none">
              <a href={`/tags/${slugify(name)}`} class="tag-pill inline-flex items-center gap-2">
                <span>#{name}</span>
                <span class="text-[10px] opacity-70">{count}</span>
              </a>
            </li>
          ))}
        </ul>
      </Container>
    </main>
    <Footer />
  </Body>
</html>
