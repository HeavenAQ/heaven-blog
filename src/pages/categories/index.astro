---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Body from '../../components/Body.astro';
import Container from '../../components/Container.astro';
import { getCollection } from 'astro:content';
import { slugify, titleCase } from '../../lib/slug';
import { getPostCategories } from '../../lib/categories';

const posts = await getCollection('blog');
const map = new Map<string, number>();
for (const p of posts) {
  for (const c of getPostCategories(p)) {
    map.set(c, (map.get(c) || 0) + 1);
  }
}
const categories = Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
---

<html lang="en">
  <head>
    <script is:inline>
      // Initialize theme BEFORE any CSS loads to prevent flash
      const theme = (() => {
        if(typeof localStorage !== 'undefined' && localStorage.getItem('theme')){
          return localStorage.getItem('theme')
        }
        if(window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark'
        }
        return 'light'
      })()

      if (theme === 'dark') {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
    </script>
    <BaseHead title="Topics" description="Browse posts by topic" />
  </head>
  <Body>
    <Header />
    <main class="pt-[80px]">
      <Container>
        <h1 class="text-2xl md:text-3xl font-bold font-mplus">Topics</h1>
        <ul class="mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
          {categories.map(([name, count]) => (
            <li>
              <a href={`/categories/${slugify(name)}`} class="flex items-center justify-between rounded-lg border border-zinc-200/60 dark:border-zinc-700/60 px-4 py-3 hover:border-orange-500/70 hover:text-orange-600 dark:hover:text-orange-400">
                <span>{titleCase(name)}</span>
                <span class="text-xs opacity-70">{count}</span>
              </a>
            </li>
          ))}
        </ul>
      </Container>
    </main>
    <Footer />
  </Body>
</html>
